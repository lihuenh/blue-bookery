stages:
  - build
  - push
  - deploy

variables:
  # Variables para Docker
  DOCKER_REGISTRY: registry.kinborg.dev
  REGISTRY_USER: $CI_REGISTRY_USER
  REGISTRY_PASSWORD: $CI_REGISTRY_PASSWORD

  # Nombres de las imágenes
  FRONTEND_IMAGE_NAME: ${DOCKER_REGISTRY}/kinborg/front
  BACKEND_IMAGE_NAME: ${DOCKER_REGISTRY}/kinborg/back

  # Tags de las imágenes
  FRONTEND_IMAGE_TAG: ${CI_COMMIT_SHORT_SHA}
  BACKEND_IMAGE_TAG: ${CI_COMMIT_SHORT_SHA}

  # Variables para Docker-in-Docker con TLS
  DOCKER_TLS_CERTDIR: '/certs'
  DOCKER_HOST: 'tcp://docker:2376'
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: '/certs/client'

# Template para construcción de imágenes Docker
.build_template: &build_definition
  image: docker:20.10.16
  services:
    - name: docker:20.10.16-dind
      command: ['--tls=false']
  before_script:
    - until docker info; do sleep 1; done
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD $DOCKER_REGISTRY

# El resto del pipeline sigue igual...
build:frontend:
  <<: *build_definition
  stage: build
  script:
    - cd frontend
    - echo "Construyendo imagen de frontend..."
    - docker build -t ${FRONTEND_IMAGE_NAME}:${FRONTEND_IMAGE_TAG} .
    - docker tag ${FRONTEND_IMAGE_NAME}:${FRONTEND_IMAGE_TAG} ${FRONTEND_IMAGE_NAME}:latest
    - 'echo "Imagen frontend construida: ${FRONTEND_IMAGE_NAME}:${FRONTEND_IMAGE_TAG}"'

build:backend:
  <<: *build_definition
  stage: build
  script:
    - cd backend
    - echo "Construyendo imagen de backend..."
    - docker build -t ${BACKEND_IMAGE_NAME}:${BACKEND_IMAGE_TAG} .
    - docker tag ${BACKEND_IMAGE_NAME}:${BACKEND_IMAGE_TAG} ${BACKEND_IMAGE_NAME}:latest
    - 'echo "Imagen backend construida: ${BACKEND_IMAGE_NAME}:${BACKEND_IMAGE_TAG}"'

push:images:
  <<: *build_definition
  stage: push
  script:
    - echo "Enviando imágenes al registro..."
    - docker push ${FRONTEND_IMAGE_NAME}:${FRONTEND_IMAGE_TAG}
    - docker push ${FRONTEND_IMAGE_NAME}:latest
    - docker push ${BACKEND_IMAGE_NAME}:${BACKEND_IMAGE_TAG}
    - docker push ${BACKEND_IMAGE_NAME}:latest
    - echo "Imágenes enviadas exitosamente"
  needs:
    - build:frontend
    - build:backend

deploy:local:
  <<: *build_definition
  stage: deploy
  script:
    - apk add --no-cache docker-compose
    - echo "Actualizando docker-compose.yml con las nuevas imágenes..."
    - sed -i "s|registry.kinborg.dev/kinborg/front:latest|${FRONTEND_IMAGE_NAME}:${FRONTEND_IMAGE_TAG}|g" docker-compose.yml
    - sed -i "s|registry.kinborg.dev/kinborg/back:latest|${BACKEND_IMAGE_NAME}:${BACKEND_IMAGE_TAG}|g" docker-compose.yml

    - |
      cat > .env << EOF
      # MySQL Configuration
      MYSQLDB_USER=$MYSQLDB_USER
      MYSQLDB_PASSWORD=$MYSQLDB_PASSWORD
      MYSQLDB_ROOT_PASSWORD=$MYSQLDB_ROOT_PASSWORD
      MYSQLDB_DATABASE=$MYSQLDB_DATABASE
      MYSQLDB_LOCAL_PORT=$MYSQLDB_LOCAL_PORT
      MYSQLDB_DOCKER_PORT=$MYSQLDB_DOCKER_PORT
      MYSQLDB_HOST=$MYSQLDB_HOST

      # Node Configuration
      NODE_LOCAL_PORT=$NODE_LOCAL_PORT
      NODE_DOCKER_PORT=$NODE_DOCKER_PORT

      # Server URLs
      SERVER_URL=$SERVER_URL
      PUBLIC_HOST=$PUBLIC_HOST
      EOF

    - docker-compose down
    - docker-compose up -d
    - docker-compose ps
    - echo "Aplicación desplegada exitosamente en el entorno local"
  needs:
    - push:images
  only:
    - main
    - master
